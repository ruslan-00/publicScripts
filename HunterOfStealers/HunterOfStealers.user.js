// ==UserScript==
// @name         Hunter of Stealers
// @namespace
// @version      1.4
// @description  Track stealers of medals in eRepublik
// @author       Stribozh
// @match        https://www.erepublik.com/en/military/campaigns*
// @icon         https://www.erepublik.com/favicon.ico
// @updateURL    https://github.com/ruslan-00/publicScripts/raw/refs/heads/main/HunterOfStealers/HunterOfStealers.user.js
// @downloadURL  https://github.com/ruslan-00/publicScripts/raw/refs/heads/main/HunterOfStealers/HunterOfStealers.user.js
// @grant        GM_xmlhttpRequest
// ==/UserScript==
(function(){"use strict";function e(e){const t=document.createElement("div");t.style.position="absolute",t.style.backgroundColor="#fff",t.style.border="4px solid #469bcc",t.style.padding="10px",t.style.boxShadow="0 0 16px 0 rgba(0,0,0,.5),inset 0 0 4px 0 rgba(16,71,87,.34)",t.style.borderRadius="8px",t.style.zIndex="1000",t.style.width="250px",t.style.display="flex",t.style.flexDirection="column",t.style.minHeight="330px";const n=e.getBoundingClientRect();return t.style.top=`${n.bottom+window.scrollY+15}px`,t.style.right="2px",document.body.appendChild(t),t}async function t(){const e=await fetch(`${i}/military/campaigns`),t=await e.text(),n=t.match(/var csrfToken = '([a-f0-9]{32})';/i);if(n&&n[1])return n[1];throw new Error("CSRF token not found")}function n(e){return new Promise(t=>setTimeout(t,e))}let o,l,r,s,i="https://www.erepublik.com/en",a="https://erepublik.xn--h1afiajie1b6j.zt.ua/api/stealers",d={},c="",p=0,y="You are not registered. Send a message in the game Stribozh about your desire to activate the application for a trial period of 1 week. In the future, the cost of using the application is 20,000 cc per month.";fetch(`${i}/military/campaigns`).then(e=>e.text()).then(e=>{const t=e.match(/<a class="user_name" href="\/en\/citizen\/profile\/(\d+)">/);if(t&&t[1])return c=encodeURIComponent(btoa(parseInt(t[1],10).toString())),fetch(`${a}/?user_id=${c}`);throw new Error("User ID not found")}).then(e=>e.json()).then(e=>{Array.isArray(e.data)&&(e.data={}),d=e.data;Object.keys(d)[0];o=e.count});const u=document.createElement("div");u.style.position="fixed",u.style.top="100px",u.style.right="2px",u.style.zIndex=1e3,u.style.backgroundColor="#F3F1F1",u.style.border="1px solid #ccc",u.style.borderRadius="5px",u.style.padding="5px",u.style.width="120px",u.style.display="flex",u.style.flexDirection="column",u.style.alignItems="center";const m=document.createElement("button");m.innerHTML=`<img src="${a}/hunter.png" style="width: 30px; height: 30px; float: left;margin-right: 4px;" > Hunter of Stealer`,m.style.padding="10px 10px",m.style.backgroundColor="#1e95c1",m.style.color="white",m.style.border="none",m.style.borderRadius="5px",m.style.cursor="pointer",m.style.width="100%",u.appendChild(m),document.body.appendChild(u),m.addEventListener("click",()=>{if(l)l.remove(),l=null;else{l=e(m),r=document.createElement("div"),r.style.display="flex",r.style.borderBottom="1px solid #ccc";const w=g("Search",{borderBottom:"2px solid #1e95c1"}),v=g("Statistics"),E=g("Add");r.appendChild(w),r.appendChild(v),r.appendChild(E),s=document.createElement("div"),s.style.flex="1",s.style.padding="10px";const $=document.createElement("div"),T=document.createElement("div"),B=document.createElement("div");$.style.display="block",T.style.display="none",B.style.display="none",s.appendChild($),s.appendChild(T),s.appendChild(B),l.appendChild(r),l.appendChild(s),w.addEventListener("click",()=>{$.style.display="block",T.style.display="none",B.style.display="none",w.style.borderBottom="2px solid #1e95c1",v.style.borderBottom="none",E.style.borderBottom="none"}),v.addEventListener("click",()=>{$.style.display="none",T.style.display="block",B.style.display="none",w.style.borderBottom="none",v.style.borderBottom="2px solid #1e95c1",E.style.borderBottom="none"}),E.addEventListener("click",()=>{$.style.display="none",T.style.display="none",B.style.display="block",w.style.borderBottom="none",v.style.borderBottom="none",E.style.borderBottom="2px solid #1e95c1"});const S=document.createElement("div");S.style.backgroundColor="#E0E0E0",S.style.border="1px solid #ccc",S.style.borderRadius="5px",S.style.width="95%",S.style.marginTop="10px",S.style.padding="5px";const _=document.createElement("div");_.style.height="20px",_.style.width="0%",_.style.backgroundColor="#84b23b",_.style.borderRadius="5px",_.style.textAlign="center",_.style.color="black",_.style.display="grid",_.style.alignItems="center",_.innerText="0%",S.appendChild(_);const j=document.createElement("div");j.style.backgroundColor="#FFFFFF",j.style.border="1px solid #ccc",j.style.borderRadius="5px",j.style.padding="5px",j.style.minHeight="140px",j.style.overflowY="auto",j.style.width="95%",j.style.marginTop="10px";const A=document.createElement("div");A.style.marginBottom="10px",A.style.display="flex",A.style.gap="10px",A.style.justifyContent="center";for(let e=1;e<=5;e++){const t=document.createElement("label");t.style.display="flex",t.style.flexDirection="raw",t.style.alignItems="center",t.style.cursor="pointer";const n=document.createElement("input");n.type="checkbox",n.id=`checkbox${e}`,n.name=`option${e}`,n.value=`option${e}`,n.style.appearance="none",n.style.width="20px",n.style.height="20px",n.style.border="2px solid #ccc",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.position="relative",n.style.transition="background-color 0.3s, border-color 0.3s";const o=document.createElement("span");o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.color="white",o.style.fontSize="14px",o.style.display="none",n.addEventListener("change",e=>{e.target.checked?p<2?(p++,n.style.backgroundColor="#1e95c1",n.style.borderColor="#1e95c1",o.style.display="block"):e.target.checked=!1:(p--,n.style.backgroundColor="transparent",n.style.borderColor="#ccc",o.style.display="none")}),t.appendChild(n),t.appendChild(o),t.appendChild(document.createTextNode(` D${e}`)),A.appendChild(t)}const F=document.createElement("button");F.innerText="Search stealers",F.style.padding="10px 10px",F.style.backgroundColor="#1e95c1",F.style.color="white",F.style.border="none",F.style.borderRadius="5px",F.style.cursor="pointer",F.style.width="100%";let L,z=!1,I=new AbortController;F.addEventListener("click",async()=>{1===o?z?h():(u(),F.disabled=!0,F.disabled=!1):alert(y)}),$.appendChild(A),$.appendChild(F),$.appendChild(S),$.appendChild(j);const O=document.createElement("div");O.style.backgroundColor="#FFFFFF",O.style.border="1px solid #ccc",O.style.borderRadius="5px",O.style.padding="5px",O.style.maxHeight="250px",O.style.overflowY="auto",O.style.width="97%",O.style.marginTop="10px",k(),T.appendChild(O);const R=document.createElement("div");R.style.display="flex",R.style.flexDirection="column";const D=document.createElement("input");D.type="number",D.placeholder="Stealer ID (up to 7 numbers)",D.maxLength=7,D.style.marginBottom="10px";const H=document.createElement("input");H.type="number",H.placeholder="Stolen Battle ID (up to 7 numbers)",H.maxLength=7,H.style.marginBottom="10px";const P=document.createElement("input");P.type="number",P.placeholder="Returned Battle ID (up to 7 numbers)",P.maxLength=7,P.style.marginBottom="10px";const M=document.createElement("textarea");M.placeholder="Comment (up to 200 characters)",M.maxLength=200,M.style.marginBottom="10px",M.style.resize="none";const N=document.createElement("div");N.innerText="",N.style.marginTop="10px",N.style.color="#1e95c1",N.style.display="none",N.style.display="block",N.style.textAlign="center";const U=document.createElement("button");function u(){d&&0!==Object.keys(d).length?(z=!0,F.disabled=!0,F.innerText="Stop?",j.innerHTML="",_.style.width="0%",I=new AbortController,b()):console.log("Stealers list is empty, search will not start.")}function h(){z=!1,clearInterval(L),I.abort(),F.innerText="Search stealers",F.disabled=!1}async function b(){try{await f(_,j)}catch(e){console.error("Помилка під час пошуку:",e);const t=document.createElement("div");t.innerText="An error occurred while searching.",t.style.color="red",j.appendChild(t)}finally{F.disabled=!1,F.innerText="Знайти крадіїв",z=!1}}async function f(e,n){const o=`${i}/military/campaignsJson/list`,l=[],r=[];for(let e=1;e<=5;e++){const t=document.getElementById(`checkbox${e}`);t&&t.checked&&r.push(e)}try{const s=await fetch(o,{signal:I.signal});if(I.signal.aborted)return;const i=await s.json();if(i){let o=Object.entries(i.battles);o.sort(([,e],[,t])=>e.start-t.start);const s=await t();let a=0;const c=o.length;for(const[t,i]of o){if(!z)break;for(const e in i.div){if(!z)break;const o=i.div[e];(r.includes(1)&&1===o.div||r.includes(2)&&2===o.div||r.includes(3)&&3===o.div||r.includes(4)&&4===o.div||r.includes(5)&&11===o.div)&&(await x(t,e,s,d,n),l.push({battleKey:t,divKey:e,battle:i,div:o}))}a++;const o=Math.min(a/c*100,100);e.style.width=o+"%",e.innerText=Math.floor(o)+"%"}}}catch(e){"AbortError"===e.name||console.error(e)}finally{F.innerText="Search stealers",F.disabled=!1,z=!1}}async function x(e,t,o,l,r){const s=new URLSearchParams({action:"battleStatistics",type:"damage",leftPage:1,rightPage:1,battleZoneId:t,_token:o});try{if(!z)return;const o=await fetch(`${i}/military/battle-console`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Cookie:document.cookie},body:s.toString(),signal:I.signal});if(I.signal.aborted)return;const a=await o.json();if(a)for(const n in a){if(!z)return;if(a[n].fighterData){const o=a[n].fighterData,s=Object.keys(o).filter(e=>l.hasOwnProperty(o[e].citizenId));if(s.length>0){const n=`${i}/military/battlefield/`+e+"/"+t;s.forEach(e=>{const t=o[e].citizenId,s=l[t],i=Object.keys(s.stolenBattle_id).length,a=Object.keys(s.returnedBattle_id).length,d=document.createElement("div");d.style.marginBottom="10px";const c=o[e].citizenName;d.innerHTML=`<a href="${n}" target="_blank">${c}</a> (${i} / ${a})`,r.appendChild(d)});break}}}}catch(e){"AbortError"===e.name||console.error("Помилка під час POST-запиту:",e)}finally{if(!z)return;await n(2e3)}}function g(e,t={}){const n=document.createElement("button");n.innerText=e,n.style.flex="1",n.style.padding="10px",n.style.border="none",n.style.backgroundColor="#f9f9f9",n.style.cursor="pointer";for(const[e,o]of Object.entries(t))n.style[e]=o;return n}function k(){if(!d||0===Object.keys(d).length)return console.log("No stealers found."),void(O.innerHTML="<p>No stealers recorded.</p>");if(1==o){let e="";for(let t in d){const n=d[t],o=Object.keys(n.stolenBattle_id).length,l=Object.keys(n.returnedBattle_id).length;let r="";for(let e in n.stolenBattle_id){const t=n.stolenBattle_id[e];r+=`\n<li>\n<a href="${i}/military/battlefield/${e}"\ntitle="Created: ${t.created}, Comment: ${t.comment}"\ntarget="_blank">\n${e}\n</a>\n</li>`}let s="";for(let e in n.returnedBattle_id){const t=n.returnedBattle_id[e];s+=`\n<li>\n<a href="${i}/military/battlefield/${e}"\ntitle="Created: ${t.created}, Comment: ${t.comment}"\ntarget="_blank">\n${e}\n</a>\n</li>`}e+=`\n<a href="${i}/citizen/profile/${t}" target="_blank">${n.user_name}</a> - ${o}/${l}\n<button class="delete-button"\nstyle="background:#1e95c1; color:white; border-radius:50px; border:1px; font-size:11px; cursor:pointer;"\ndata-user-id=${c}\ndata-stealer-id=${t}\ndata-is-delete=1>Delete</button>\n<br>\n<details>\n<summary>Stolen Battles (${o})</summary>\n<ul>\n${r}\n</ul>\n</details>\n<details>\n<summary>Returned Battles (${l})</summary>\n<ul>\n${s}\n</ul>\n</details>\n<br>\n`}O.innerHTML=e;const t=O.querySelectorAll(".delete-button");t.forEach(e=>{e.addEventListener("click",C)})}}async function C(e){const t=`${a}/`,n=e.target,o=n.getAttribute("data-user-id"),l=n.getAttribute("data-stealer-id"),r=n.getAttribute("data-is-delete"),s={user_id:o,stealer_id:l,isDelete:r};try{const e=await fetch(t,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),n=await e.json();n.message?alert("User delete"):alert("Not found")}catch(e){alert("An error occurred while sending data.")}}U.innerText="Send",U.style.padding="10px 20px",U.style.backgroundColor="#1e95c1",U.style.color="#fff",U.style.border="none",U.style.borderRadius="5px",U.style.cursor="pointer",R.appendChild(D),R.appendChild(H),R.appendChild(P),R.appendChild(M),R.appendChild(U),R.appendChild(N),document.body.appendChild(R),B.appendChild(R),s.appendChild($),s.appendChild(T),s.appendChild(B),l.appendChild(r),l.appendChild(s),U.addEventListener("click",()=>{if(1!==o)return void alert(y);const e=D.value.trim(),t=H.value.trim(),n=P.value.trim(),l=M.value.trim();e&&(t||n)?fetch(`${i}/main/citizen-profile-json-personal/${e}`).then(e=>e.json()).then(o=>{const r=o.citizen.name,s={user_id:c,user_name:r,stealer_id:e,stolenBattle_id:t,returnedBattle_id:n,comment:l};return fetch(`${a}/`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"*/*",Host:"","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive"},body:JSON.stringify(s)})}).then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{N.innerText="Information recorded",N.style.color="#1e95c1",N.style.display="block",D.value="",H.value="",P.value="",M.value="",setTimeout(()=>{N.style.display="none"},3e3)}).catch(e=>{console.error("Error:",e),N.innerText="Error sending data \n Check the entered data",N.style.color="red",N.style.display="block",setTimeout(()=>{N.style.display="none"},5e3)}):alert("Please fill in all fields!")})}});const h=document.createElement("style");h.innerHTML='\ninput:focus, textarea:focus {\nborder: 1px solid #eebe4c;\nbox-shadow: 0 0 3px #f1ca7f;\n}\ninput, textarea {\nborder: 1px solid #e0e0e0;\nborder-radius: 5px;\nfont-family: Arial, sans-serif;\nfloat: left;\nposition: relative;\nclear: both;\nfont-size: 10px;\noutline: 0;\npadding: 8px 5px;\ncolor: #4d4d4d;\nmargin: 1px;\nbox-shadow: inset 0 1px 3px #F2F2F2, 0 1px 0 #fff;\n-webkit-transition: border .25s ease-in-out, box-shadow .25s ease-in-out;\ntransition: border .25s ease-in-out, box-shadow .25s ease-in-out;\n-webkit-appearance: none;\nresize: none;\n}\ninput[type="checkbox"] {\nwidth: 20px;\nheight: 20px;\nmargin-right: 1px;\ncursor: pointer;\nappearance: none;\nborder: 2px solid #ccc;\nborder-radius: 4px;\ntransition: background-color 0.3s, border-color 0.3s;\n}\ninput[type="checkbox"]:checked {\nbackground-color: #1e95c1;\nborder-color: #1e95c1;\nanimation: checkAnim 0.3s ease;\n}\ninput[type="checkbox"]:checked::after {\ncontent: "✔";\nposition: absolute;\ntop: 50%;\nleft: 50%;\ntransform: translate(-50%, -50%);\ncolor: white;\nfont-size: 10px;\n}\n@keyframes checkAnim {\n0% {\n    transform: scale(1);\n}\n50% {\n    transform: scale(1.2);\n}\n100% {\n    transform: scale(1);\n}\n}\n',document.head.appendChild(h)})();