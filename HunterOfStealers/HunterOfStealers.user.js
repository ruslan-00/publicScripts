// ==UserScript==
// @name         Hunter of Stealers
// @namespace
// @version      1.4
// @description  Track stealers of medals in eRepublik
// @author       Stribozh
// @match        https://www.erepublik.com/en/military/campaigns*
// @icon         https://www.erepublik.com/favicon.ico
// @updateURL    https://github.com/ruslan-00/publicScripts/raw/refs/heads/main/HunterOfStealers/HunterOfStealers.user.js
// @downloadURL  https://github.com/ruslan-00/publicScripts/raw/refs/heads/main/HunterOfStealers/HunterOfStealers.user.js
// @grant        GM_xmlhttpRequest
// ==/UserScript==
(function(){"use strict";function e(){if(!s)return;let e=document.getElementById("tab1"),n=document.getElementById("tab2"),o=document.getElementById("tab3"),r=t("Message"),l=document.createElement("div");l.innerHTML='You are not registered. </br>&#9826; &#9826; &#9826;</br>\n    Send a message in the game </br><a style="text-decoration: none; font-weight: bold;"\n    href="https://www.erepublik.com/en/main/messages-compose/7963530" target="_blank">&#128386; Stribozh</a>\n    about your desire to activate the application for a trial period of 1 week </br>&#9826; &#9826; &#9826;</br>\n    In the future, the cost of using the application is 20,000 cc per month</br>',l.style.textAlign="center",l.style.padding="20px",l.style.display="none",l.style.color="#777777",i.appendChild(r),a.appendChild(l),r.addEventListener("click",()=>{content1.style.display="none",content2.style.display="none",content3.style.display="none",l.style.display="block",e.style.borderBottom="none",n.style.borderBottom="none",o.style.borderBottom="none",r.style.borderBottom="2px solid #1e95c1"}),l.style.display="block",e.style.borderBottom="none",n.style.borderBottom="none",o.style.borderBottom="none",r.style.borderBottom="2px solid #1e95c1"}function t(e,t={}){const n=document.createElement("button");n.innerText=e,n.style.flex="1",n.style.padding="10px",n.style.border="none",n.style.backgroundColor="#f9f9f9",n.style.cursor="pointer";for(const[e,o]of Object.entries(t))n.style[e]=o;return n}function n(e){const t=document.createElement("div");t.style.position="absolute",t.style.backgroundColor="#fff",t.style.border="4px solid #469bcc",t.style.padding="10px",t.style.boxShadow="0 0 16px 0 rgba(0,0,0,.5),inset 0 0 4px 0 rgba(16,71,87,.34)",t.style.borderRadius="8px",t.style.zIndex="1000",t.style.width="250px",t.style.display="flex",t.style.flexDirection="column",t.style.minHeight="330px";const n=e.getBoundingClientRect();return t.style.top=`${n.bottom+window.scrollY+15}px`,t.style.right="2px",document.body.appendChild(t),t}async function o(){const e=await fetch(`${d}/military/campaigns`),t=await e.text(),n=t.match(/var csrfToken = '([a-f0-9]{32})';/i);if(n&&n[1])return n[1];throw new Error("CSRF token not found")}function r(e){return new Promise(t=>setTimeout(t,e))}let l,s,i,a,d="https://www.erepublik.com/en",c="https://erepublik.xn--h1afiajie1b6j.zt.ua/api/stealers",p={},y="";fetch(`${d}/military/campaigns`).then(e=>e.text()).then(e=>{const t=e.match(/<a class="user_name" href="\/en\/citizen\/profile\/(\d+)">/);if(t&&t[1])return y=encodeURIComponent(btoa(parseInt(t[1],10).toString())),fetch(`${c}/?user_id=${y}`);throw new Error("User ID not found")}).then(e=>e.json()).then(t=>{if("User not found or not active"===t.error)s?e():window.showErrorTab=!0;else{p=t;let e=Object.keys(p)[0];l=p[e].count}}).catch(e=>{console.error("Error:",e)});const u=document.createElement("div");u.style.position="fixed",u.style.top="100px",u.style.right="2px",u.style.zIndex=1e3,u.style.backgroundColor="#F3F1F1",u.style.border="1px solid #ccc",u.style.borderRadius="5px",u.style.padding="5px",u.style.width="120px",u.style.display="flex",u.style.flexDirection="column",u.style.alignItems="center";const m=document.createElement("button");m.innerHTML=`<img src="${c}/hunter.png" style="width: 30px; height: 30px; float: left;margin-right: 4px;" /> Hunter of Stealer`,m.style.padding="10px 10px",m.style.backgroundColor="#1e95c1",m.style.color="white",m.style.border="none",m.style.borderRadius="5px",m.style.cursor="pointer",m.style.width="100%",u.appendChild(m),document.body.appendChild(u);const b=document.createElement("style");b.innerHTML='\n        input:focus, textarea:focus {\n            border: 1px solid #eebe4c;\n            box-shadow: 0 0 3px #f1ca7f;\n        }\n        input, textarea {\n            border: 1px solid #e0e0e0;\n            border-radius: 5px;\n            font-family: Arial, sans-serif;\n            float: left;\n            position: relative;\n            clear: both;\n            font-size: 10px;\n            outline: 0;\n            padding: 8px 5px;\n            color: #4d4d4d;\n            margin: 1px;\n            box-shadow: inset 0 1px 3px #F2F2F2, 0 1px 0 #fff;\n            -webkit-transition: border .25s ease-in-out, box-shadow .25s ease-in-out;\n            transition: border .25s ease-in-out, box-shadow .25s ease-in-out;\n            -webkit-appearance: none;\n            resize: none;\n        }\n        input[type="checkbox"] {\n            width: 20px;\n            height: 20px;\n            margin-right: 1px;\n            cursor: pointer;\n            appearance: none;\n            border: 2px solid #ccc;\n            border-radius: 4px;\n            transition: background-color 0.3s, border-color 0.3s;\n        }\n        input[type="checkbox"]:checked {\n            background-color: #1e95c1;\n            border-color: #1e95c1;\n            animation: checkAnim 0.3s ease;\n        }\n        input[type="checkbox"]:checked::after {\n            content: "âœ”";\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            color: white;\n            font-size: 10px;\n        }\n        @keyframes checkAnim {\n            0% {\n                transform: scale(1);\n            }\n            50% {\n                transform: scale(1.2);\n            }\n            100% {\n                transform: scale(1);\n            }\n        }\n    ',document.head.appendChild(b),m.addEventListener("click",()=>{if(s)s.remove(),s=null;else{s=n(m),i=document.createElement("div"),i.style.display="flex",i.style.borderBottom="1px solid #ccc";const w=t("Search",{borderBottom:"2px solid #1e95c1"}),C=t("Statistics"),E=t("Add");i.appendChild(w),i.appendChild(C),i.appendChild(E),a=document.createElement("div"),a.style.flex="1",a.style.padding="10px";const v=document.createElement("div"),B=document.createElement("div"),$=document.createElement("div");v.style.display="block",B.style.display="none",$.style.display="none",a.appendChild(v),a.appendChild(B),a.appendChild($),s.appendChild(i),s.appendChild(a),window.showErrorTab&&(e(),window.showErrorTab=!1),w.addEventListener("click",()=>{v.style.display="block",B.style.display="none",$.style.display="none",w.style.borderBottom="2px solid #1e95c1",C.style.borderBottom="none",E.style.borderBottom="none"}),C.addEventListener("click",()=>{v.style.display="none",B.style.display="block",$.style.display="none",w.style.borderBottom="none",C.style.borderBottom="2px solid #1e95c1",E.style.borderBottom="none"}),E.addEventListener("click",()=>{v.style.display="none",B.style.display="none",$.style.display="block",w.style.borderBottom="none",C.style.borderBottom="none",E.style.borderBottom="2px solid #1e95c1"});const T=document.createElement("div");T.style.backgroundColor="#E0E0E0",T.style.border="1px solid #ccc",T.style.borderRadius="5px",T.style.width="95%",T.style.marginTop="10px",T.style.padding="5px";const S=document.createElement("div");S.style.height="20px",S.style.width="0%",S.style.backgroundColor="#84b23b",S.style.borderRadius="5px",S.style.textAlign="center",S.style.color="black",S.style.display="grid",S.style.alignItems="center",S.innerText="0%",T.appendChild(S);const _=document.createElement("div");_.style.backgroundColor="#FFFFFF",_.style.border="1px solid #ccc",_.style.borderRadius="5px",_.style.padding="5px",_.style.minHeight="140px",_.style.overflowY="auto",_.style.width="95%",_.style.marginTop="10px";let A=0;const I=document.createElement("div");I.style.marginBottom="10px",I.style.display="flex",I.style.gap="10px",I.style.justifyContent="center";for(let e=1;e<=5;e++){const t=document.createElement("label");t.style.display="flex",t.style.flexDirection="raw",t.style.alignItems="center",t.style.cursor="pointer";const n=document.createElement("input");n.type="checkbox",n.id=`checkbox${e}`,n.name=`option${e}`,n.value=`option${e}`,n.style.appearance="none",n.style.width="20px",n.style.height="20px",n.style.border="2px solid #ccc",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.position="relative",n.style.transition="background-color 0.3s, border-color 0.3s";const o=document.createElement("span");o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.color="white",o.style.fontSize="14px",o.style.display="none",n.addEventListener("change",e=>{e.target.checked?A<2?(A++,n.style.backgroundColor="#1e95c1",n.style.borderColor="#1e95c1",o.style.display="block"):e.target.checked=!1:(A--,n.style.backgroundColor="transparent",n.style.borderColor="#ccc",o.style.display="none")}),t.appendChild(n),t.appendChild(o),t.appendChild(document.createTextNode(` D${e}`)),I.appendChild(t)}const j=document.createElement("button");j.innerText="Search stealers",j.style.padding="10px 10px",j.style.backgroundColor="#1e95c1",j.style.color="white",j.style.border="none",j.style.borderRadius="5px",j.style.cursor="pointer",j.style.width="100%";let L,F=!1,z=new AbortController;function u(){F=!0,j.disabled=!0,j.innerText="Stop?",_.innerHTML="",S.style.width="0%",z=new AbortController,h()}function b(){F=!1,clearInterval(L),z.abort(),j.innerText="Search stealers",j.disabled=!1}async function h(){try{await f(S,_)}catch(e){const t=document.createElement("div");t.innerText="An error occurred while searching.",t.style.color="red",_.appendChild(t)}finally{j.disabled=!1,j.innerText="Search stealers",F=!1}}async function f(e,t){const n=`${d}/military/campaignsJson/list`,r=[],l=[];for(let e=1;e<=5;e++){const t=document.getElementById(`checkbox${e}`);t&&t.checked&&l.push(e)}try{const s=await fetch(n,{signal:z.signal});if(z.signal.aborted)return;const i=await s.json();if(i){let n=Object.entries(i.battles);n.sort(([,e],[,t])=>e.start-t.start);const s=await o();let a=0;const d=n.length;for(const[o,i]of n){if(!F)break;for(const e in i.div){if(!F)break;const n=i.div[e];(l.includes(1)&&1===n.div||l.includes(2)&&2===n.div||l.includes(3)&&3===n.div||l.includes(4)&&4===n.div||l.includes(5)&&11===n.div)&&(await x(o,e,s,p,t),r.push({battleKey:o,divKey:e,battle:i,div:n}))}a++;const n=Math.min(a/d*100,100);e.style.width=n+"%",e.innerText=Math.floor(n)+"%"}}}catch(e){"AbortError"===e.name||console.error(e)}finally{j.innerText="Search stealers",j.disabled=!1,F=!1}}async function x(e,t,n,o,l){const s=new URLSearchParams({action:"battleStatistics",type:"damage",leftPage:1,rightPage:1,battleZoneId:t,_token:n});try{if(!F)return;const n=await fetch(`${d}/military/battle-console`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Cookie:document.cookie},body:s.toString(),signal:z.signal});if(z.signal.aborted)return;const i=await n.json();if(i)for(const n in i){if(!F)return;if(i[n].fighterData){const r=i[n].fighterData,s=Object.keys(r).filter(e=>o.hasOwnProperty(r[e].citizenId));if(s.length>0){const n=`${d}/military/battlefield/`+e+"/"+t;s.forEach(e=>{const t=r[e].citizenId,s=o[t],i=Object.keys(s.stolenBattle_id).length,a=Object.keys(s.returnedBattle_id).length,d=document.createElement("div");d.style.marginBottom="10px";const c=r[e].citizenName;d.innerHTML=`<a href="${n}" target="_blank">${c}</a> (${i} / ${a})`,l.appendChild(d)});break}}}}catch(e){"AbortError"===e.name?console.log("AbortError"):console.error(e)}finally{if(!F)return;await r(2e3)}}j.addEventListener("click",async()=>{1===l?F?b():(u(),j.disabled=!0,j.disabled=!1):alert("Your account is not activated")}),v.appendChild(I),v.appendChild(j),v.appendChild(T),v.appendChild(_);const R=document.createElement("div");function g(){let e="";for(let t in p){const n=p[t],o=Object.keys(n.stolenBattle_id).length,r=Object.keys(n.returnedBattle_id).length;let l="";for(let e in n.stolenBattle_id){const t=n.stolenBattle_id[e];l+=`\n                <li>\n                    <a href="${d}/military/battlefield/${e}"\n                       title="Created: ${t.created}, Comment: ${t.comment}"\n                       target="_blank">\n                        ${e}\n                    </a>\n                </li>`}let s="";for(let e in n.returnedBattle_id){const t=n.returnedBattle_id[e];s+=`\n                <li>\n                    <a href="${d}/military/battlefield/${e}"\n                       title="Created: ${t.created}, Comment: ${t.comment}"\n                       target="_blank">\n                        ${e}\n                    </a>\n                </li>`}e+=`\n            <a href="${d}/citizen/profile/${t}" target="_blank">${n.user_name}</a> - ${o}/${r}\n            <button class="delete-button"\n            style="background:#1e95c1; color:white; border-radius:50px; border:1px; font-size:11px; cursor:pointer;"\n                    data-user-id=${y}\n                    data-stealer-id=${t}\n                    data-is-delete=1>Delete</button>\n            <br>\n            <details>\n                <summary>Stolen Battles (${o})</summary>\n                <ul>\n                    ${l}\n                </ul>\n            </details>\n            <details>\n                <summary>Returned Battles (${r})</summary>\n                <ul>\n                    ${s}\n                </ul>\n            </details>\n            <br>\n            `}R.innerHTML=e;const t=R.querySelectorAll(".delete-button");t.forEach(e=>{e.addEventListener("click",k)})}async function k(e){const t=`${c}/`,n=e.target,o=n.getAttribute("data-user-id"),r=n.getAttribute("data-stealer-id"),l=n.getAttribute("data-is-delete"),s={user_id:o,stealer_id:r,isDelete:l};try{const e=await fetch(t,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),n=await e.json();console.log(n),n.message?alert("User deleted"):alert("Not found")}catch(e){console.error(e),alert("An error occurred while sending data.")}}R.style.backgroundColor="#FFFFFF",R.style.border="1px solid #ccc",R.style.borderRadius="5px",R.style.padding="5px",R.style.maxHeight="250px",R.style.overflowY="auto",R.style.width="97%",R.style.marginTop="10px",g(),B.appendChild(R);const D=document.createElement("div");D.style.display="flex",D.style.flexDirection="column";const H=document.createElement("input");H.type="number",H.placeholder="Stealer ID (up to 7 numbers)",H.maxLength=7,H.style.marginBottom="10px";const O=document.createElement("input");O.type="number",O.placeholder="Stolen Battle ID (up to 7 numbers)",O.maxLength=7,O.style.marginBottom="10px";const P=document.createElement("input");P.type="number",P.placeholder="Returned Battle ID (up to 7 numbers)",P.maxLength=7,P.style.marginBottom="10px";const M=document.createElement("textarea");M.placeholder="Comment (up to 200 characters)",M.maxLength=200,M.style.marginBottom="10px",M.style.resize="none";const Y=document.createElement("div");Y.innerText="",Y.style.marginTop="10px",Y.style.color="#1e95c1",Y.style.display="none",Y.style.display="block",Y.style.textAlign="center";const N=document.createElement("button");N.innerText="Send",N.style.padding="10px 20px",N.style.backgroundColor="#1e95c1",N.style.color="#fff",N.style.border="none",N.style.borderRadius="5px",N.style.cursor="pointer",D.appendChild(H),D.appendChild(O),D.appendChild(P),D.appendChild(M),D.appendChild(N),D.appendChild(Y),document.body.appendChild(D),N.addEventListener("click",()=>{if(1!==l)return void alert("Your account is not activated");const e=H.value.trim(),t=O.value.trim(),n=P.value.trim(),o=M.value.trim();e&&(t||n)?fetch(`${d}/main/citizen-profile-json-personal/${e}`).then(e=>e.json()).then(r=>{const l=r.citizen.name,s={user_id:y,user_name:l,stealer_id:e,stolenBattle_id:t,returnedBattle_id:n,comment:o};return fetch(`${c}/`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"*/*",Host:"","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive"},body:JSON.stringify(s)})}).then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{Y.innerText="Information recorded",Y.style.color="#1e95c1",Y.style.display="block",H.value="",O.value="",P.value="",M.value="",setTimeout(()=>{Y.style.display="none"},3e3)}).catch(e=>{console.error("Error:",e),Y.innerText="Error sending data \n Check the entered data",Y.style.display="block",setTimeout(()=>{Y.style.display="none"},5e3)}):alert("Please fill in all fields!")}),$.appendChild(D),a.appendChild(v),a.appendChild(B),a.appendChild($),s.appendChild(i),s.appendChild(a)}})})();